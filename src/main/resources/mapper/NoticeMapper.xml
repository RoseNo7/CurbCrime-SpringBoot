<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.roseno.curbcrime.mapper.NoticeMapper">

    <!-- 공지사항 -->
    <resultMap id="notice" type="com.roseno.curbcrime.domain.Notice">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="viewCount" column="view_count"/>
        <result property="createAt" column="create_at"/>
        <result property="updateAt" column="update_at"/>
        <collection property="user" ofType="com.roseno.curbcrime.domain.User">
            <id property="idx" column="user_idx"/>
            <result property="id" column="user_id"/>
            <result property="role" column="user_role"/>
        </collection>
    </resultMap>

    <!-- 공지사항 목록 개수 조회-->
    <select id="findNoticeCount">
        SELECT  COUNT(*)
        FROM    notices
        WHERE   is_deleted = FALSE

        <if test="searchOption != null and keyword != null">
            <choose>
                <when test="searchOption == 'TITLE_CONTENT'">
                    AND title LIKE CONCAT('%', #{keyword}, '%')
                    OR  content LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="searchOption == 'TITLE'">
                    AND title LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="searchOption == 'CONTENT'">
                    AND content LIKE CONCAT('%', #{keyword}, '%')
                </when>
            </choose>
        </if>
    </select>

    <!-- 공지사항 목록 조회 -->
    <select id="findNotices" resultMap="notice">
        SELECT          N.id,
                        N.title,
                        N.view_count,
                        N.create_at,
                        N.update_at,
                        U.idx AS user_idx,
                        U.id AS user_id,
                        U.role AS user_role
        FROM            notices N
        INNER JOIN      users U
        ON              N.user_idx = U.idx
        WHERE           N.is_deleted = FALSE

        <if test="searchOption != null and keyword != null">
            <choose>
                <when test="searchOption == 'TITLE_CONTENT'">
                    AND title LIKE CONCAT('%', #{keyword}, '%')
                    OR  content LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="searchOption == 'TITLE'">
                    AND title LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="searchOption == 'CONTENT'">
                    AND content LIKE CONCAT('%', #{keyword}, '%')
                </when>
            </choose>
        </if>

        ORDER BY        ${sortOption}
        LIMIT           #{limit}
        OFFSET          #{offset}
    </select>

    <!-- 공지사항 조회 -->
    <select id="findNoticeById" resultMap="notice">
        SELECT          N.id,
                        N.title,
                        N.content,
                        N.view_count,
                        N.create_at,
                        N.update_at,
                        U.idx AS user_idx,
                        U.id AS user_id,
                        U.role AS user_role
        FROM            notices N
        INNER JOIN      users U
        ON              N.user_idx = U.idx
        WHERE           N.id = #{id}
        AND             N.is_deleted = FALSE
    </select>

    <!-- 아이디 사용 여부 확인 -->
    <select id="isUsedId" resultType="boolean">
        SELECT  IF(COUNT(*) > 0, TRUE, FALSE)
        FROM    notices
        WHERE   id = #{id}
    </select>

    <!-- 공지사항 생성 -->
    <insert id="createNotice" parameterType="com.roseno.curbcrime.domain.Notice">
        INSERT INTO notices(    id,
                                user_idx,
                                title,
                                content
        )
        VALUES (    #{id},
                    #{userIdx},
                    #{title},
                    #{content}
        )
    </insert>
</mapper>